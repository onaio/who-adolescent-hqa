{% extends 'base.jinja2' %}
{% from 'macros/score_class.jinja2' import score_class %}
{% from 'macros/value_or_dash.jinja2' import value_or_dash %}
{% from 'macros/client_rows.jinja2' import generate_client_rows %}
{% block title %}{{ clinic.name }} {% endblock %}
{% block page_title %}{{ self.title() }} <span class="bold">({{ clinic.code }})</span> {% endblock %}
{% block breadcrumbs %}
  <li>
    <a href="{{ request.route_url('clinics',traverse=('')) }}">
      {{ gettext("Clinics") }}
    </a>
    <i class="icon-angle-right"></i>
  </li>
  <li>
    {{ self.page_title() }}
    <i class="icon-angle-right"></i>
  <li>
    {{period.title}}
  </li>
{% endblock %}
{% block content %}
{% include 'clinic_tool_table.jinja2' %}
  <div class="table-responsive">
    <div class="row">
      <div class="pull-left char-header">{{ gettext('Characteristics') }}</div>
      <div class="pull-right score-header">{{ gettext('Relative Score') }}</div>
    </div>
    <table class="table table-bordered scores-table">
      {% for characteristic in characteristics %}
          {% set total_responses = scores[characteristic.id].totals.total_responses %}
          {% set total_scores = scores[characteristic.id].totals.total_scores %}
          {% set percentage = scores[characteristic.id].totals.total_percentage %}
          {% set meets_threshold = scores[characteristic.id].totals.meets_threshold %}
          <thead>
          <tr>
            <th class="char-defn"></th>
            <th class="char-no center-align">{{ gettext('No.') }}</th>
            <th class="char-desc">{{ gettext('Description ') }}</th>
            <th class="char-cat">{{ gettext('Category') }}</th>
            <th class="min-max">{{ gettext('Min - Max') }}</th>
            <th class="char-resp">{{ gettext('# Respondents') }}</th>
            <th class="char-score">{{ gettext('Score') }}</th>
            <th class="char-rel-score"></th>
          </tr>
          </thead>
          <tbody>
            <tr>
              <td class="center-align ">
                <img src="{{ request.static_url('whoahqa:static/images/char_en/sm/%d.png' % characteristic.number) }}">
              </td>
              <td class="center-align char-no-vals">
                {{ characteristic.number }}
              </td>
              <td class="">{{ gettext(characteristic.description) }}
              </td>
              <td class="client-tool-table">
                <table class="table table-striped">
                  {{ generate_client_rows(scores, client_tools, characteristic.id, client_property='name', characteristic_id=characteristic.id)}}
                  <tr>
                    <td class="text-right bold">
                      {{ gettext("Absolute total score") }}
                    </td>
                  </tr>
                </table>
              </td>
              <td class="client-tool-table">
                <table class="table table-striped">
                  {{ generate_client_rows(scores, client_tools, characteristic.id, score_property='num_questions', output_prefix='0 - ', characteristic_id=characteristic.id) }}
                  <tr>
                    <td class="text-center bold">
                      0 - {{ scores[characteristic.id].totals.total_questions }}
                    </td>
                  </tr>
                </table>
              </td>
              <td class="client-tool-table">
                <table class="table table-striped respondents">
                {% for client_tool in client_tools %}
                  {% set score = scores[characteristic.id] %}
                  {% if score[client_tool.id] is defined %}
                      <tr>
                          <td>
                          {% set responses = score[client_tool.id]['num_responses']|int(0) %}
                          {% set pending_responses = score[client_tool.id]['num_pending_responses'] %}
                          {% if responses %}
                            {% for response in range(responses) %}
                              <i class="icon-blue icon-circle"></i>
                            {% endfor %}
                          {% endif %}
                          {% for response in range(pending_responses) %}
                            <i class="icon-grey icon-circle"></i>
                          {% endfor %}
                          </td>
                      </tr>
                  {% endif %}

                {% endfor %}
                  <tr>
                      <td>&nbsp;</td>
                  </tr>
                </table>
              </td>
              <td class="client-tool-table">
                  <table class="table table-striped">
                      {{ generate_client_rows(scores, client_tools, characteristic.id, score_property='aggregate_score', characteristic_id=characteristic.id) }}
                  <tr>
                      <td class="text-center">{{ total_scores|int }}</td>
                  </tr>
                  </table>
              </td>
              <td class="text-center relative-score">
                  {% if total_responses == 0 %}
                    -
                  {% else %}
                    {% set class_name = "icon-grey" %}
                    {% if meets_threshold %}
                      {% if score_classification == 'great' %}
                        {% set class_name = "icon-green" %}
                      {% elif score_classification == 'good' %}
                        {% set class_name = "icon-orange" %}
                      {% else %}
                        {% set class_name = "icon-red" %}
                      {% endif %}
                    {% endif %}
                    <i class="big icon-medkit {{ class_name }}"></i>
                    {{ "%s"| format(percentage|int(0)) }}%
                  {% endif %}
              </td>
            </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}