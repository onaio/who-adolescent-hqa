{% extends 'base.jinja2' %}
{% from 'macros/score_class.jinja2' import score_class %}
{% from 'macros/value_or_dash.jinja2' import value_or_dash %}
{% from 'macros/client_rows.jinja2' import generate_client_rows %}
{% block title %}{{ clinic.name }} {% endblock %}
{% block page_title %}{{ self.title() }} <span class="bold">({{ clinic.code }})</span> {% endblock %}

{% set municipality = clinic.municipality %}
{% set clinic_key_indicators = clinic.key_indicators(period) %}
{% set state = municipality.parent if municipality else None %}

{% block sub_menu_item %}
  {% if not request.can_view_municipality and not request.can_view_state and not request.is_super_user and not request.can_list_state %}
  <li class="">
  <a href="{{request.route_url('clinics', traverse=())}}">
  {{ gettext('Scores') }}</a>
  </li>
  {% endif %}
    {% if request.can_view_municipality %}
      <li class="selected">
        <a href="{{municipality.get_url(request, period)}}">
            {{ municipality.name|format_location_name }}
            {{ gettext(municipality.location_type|capitalize) }}
            <span class="arrow open"></span>
        </a>
      </li>
      {% for child in municipality.clinics %}
        <li class="sub-location
          {%if child.id == clinic.id%}
            active
          {% endif %} ">
          <a href="{{child.get_url(request, period)}}">
              {{ child.name|format_location_name }}
          </a>
        </li>
      {% endfor %}
    {% else %}
      {% for child in request.user.clinics %}
        <li class="
          {%if child.id == clinic.id%}
            active
          {% endif %} ">
          <a href="{{child.get_url(request, period)}}">
              {{ child.name|format_location_name }}
          </a>
        </li>
      {% endfor %}
    {% endif %}
  {% endblock %}

{% block breadcrumbs %}
  {% if request.can_list_state %}
  <li><a href="{{request.route_url('states', traverse=())}}">{{ gettext('States') }}</a></li>
  <li><a href="#"> </a></li>
  <i class="icon-angle-right"></i>
  {% endif %}
  {% if state is not none %}
    <li>
      {% if request.can_view_state or request.can_list_state %}
        <a href="{{ state.get_url(request, period)}}">
          {{ state.name|format_location_name }}
          {{ gettext(state.location_type|capitalize) }}
        </a>
        <i class="icon-angle-right"></i>
      {% endif %}
    </li>
  {% endif %}
  {% if municipality is not none %}
    <li>
      {% if request.can_view_municipality or request.can_list_state %}
        <a href="{{ municipality.get_url(request, period)}}">
          {{ municipality.name|format_location_name }}
          {{ gettext(municipality.location_type|capitalize) }}
        </a>
        <i class="icon-angle-right"></i>
      {% endif %}
    </li>
  {% endif %}
  {% if not request.can_view_municipality and not request.can_view_state and not request.is_super_user and not request.can_list_state %}
  <li>
  <i class="icon-home"></i>
  <a href="{{request.route_url('clinics', traverse=())}}">{{ gettext('Scores') }}</a></li>
  <li><a href="#"> </a></li>
  <i class="icon-angle-right"></i>
  {% endif %}
  <li>
  {{ clinic.name }}
  </li>
{% endblock %}
{% block period_selector %}
  {% if periods %}
    <div class="row" style="position: absolute; top: 7em; margin-left: 10px;">
      <div class="dashboard-date-range btn-group pull-left">
       <div id="dashboard-report-range" class="tooltips btn btn-fit-height btn-primary dropdown-toggle" data-container="body" data-placement="top" data-original-title="{{gettext('Change dashboard date range')}}" data-toggle="dropdown" aria-expanded="false">
          <i class="icon-calendar"></i>&nbsp;
             {% set active_period = selected_period or period%}
             <span class="thin uppercase visible-lg-inline-block">
                 {{ gettext(active_period.title) }}
             </span>&nbsp;
             <i class="icon-angle-down"></i>
       </div>
       <ul class="dropdown-menu" role="menu">
          {% for p in periods if p != period %}
             <li>
             <a href="{{ request.current_route_url(traverse=(clinic.id, p.id)) }}">
               {{ gettext(p.title) }}
             </a>
             </li>
          {% endfor %}
       </ul>
    </div>
    <div class="pull-left print-row">
    <button onclick="window.print();return false;" class="btn btn-default">
      <i class="icon-print"></i>
      Print
    </button>
  </div>
</div>
  {% endif %}
{% endblock %}
{% block content %}
<div class="table-responsive">
    <table class="borderless">
      <tbody>
        <tr>
          <td>Clinic: </td>
          <td>{{ self.title() }}</td>
        </tr>
        <tr>
          <td>CNES number: </td>
          <td>{{ clinic.code }}</td>
        </tr>
        <tr>
          <td>Reporting period: </td>
          {% if periods %}
            {% set active_period = selected_period or period%}
            <td>{{ gettext(active_period.title) }} </td>
          {% endif %}
        </tr>
        <tr>
          <td>Date printed: </td>
          <td id="date"></td>
        </tr>
      </tbody>
    </table>
</div>
<hr/>
<br/>
{% for key_indicator, char_list in key_indicators %}
  <div class="table-responsive">
    <div class="row">
      <h3 class="key-indicator-title">
        {{ gettext(key_indicator|capitalize)}}:
        {{ 0 or clinic_key_indicators[key_indicator]|round|int }}%
      </h3>
    </div>
    <div class="row">
      <div class="pull-left char-header">{{ gettext('Characteristics') }}</div>
      <div class="pull-right score-header hidden-print">{{ gettext('Relative Score') }}</div>
    </div>

      <table class="table table-bordered scores-table">
        {% for characteristic in characteristics if characteristic.id in char_list %}
            {% set total_responses = scores[characteristic.id].totals.total_responses %}
            {% set total_pending_responses = scores[characteristic.id].totals.total_pending_responses %}
            {% set total_scores = scores[characteristic.id].totals.total_scores %}
            {% set score_classification = scores[characteristic.id].totals.score_classification %}
            {% set percentage = scores[characteristic.id].totals.total_percentage %}
            {% set meets_threshold = scores[characteristic.id].totals.meets_threshold %}
            <thead>
              <tr>
                <th class="char-no center-align">{{ gettext('No.') }}</th>
                <th class="char-desc">{{ gettext('Description ') }}</th>
                <th class="char-cat">{{ gettext('Category') }}</th>
                <th class="min-max">{{ gettext('Min - Max') }}</th>
                <th class="char-resp">{{ gettext('# Respondents') }}</th>
                <th class="char-score">{{ gettext('Score') }}</th>
                <th class="char-rel-score">
                  <span class="for-print">{{ gettext('Relative Score') }}</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="center-align char-no-vals">
                  {{ characteristic.number }}
                </td>
                <td class="">
                  <p>{{ gettext(characteristic.description) }}</p>
                </td>
                <td class="client-tool-table">
                  <table class="table table-striped">
                    {{ generate_client_rows(scores, client_tools, characteristic.id, client_property='name', characteristic_id=characteristic.id)}}
                    <tr>
                      <td class="text-right bold">
                        {{ gettext("Absolute total score") }}
                      </td>
                    </tr>
                  </table>
                </td>
                <td class="client-tool-table">
                  <table class="table table-striped">
                    {{ generate_client_rows(scores, client_tools, characteristic.id, score_property='num_questions', output_prefix='0 - ', characteristic_id=characteristic.id) }}
                    <tr>
                      <td class="text-center bold">
                        0 - {{ scores[characteristic.id].totals.total_questions }}
                      </td>
                    </tr>
                  </table>
                </td>
                <td class="client-tool-table">
                  <table class="table table-striped respondents">
                  {% for client_tool in client_tools %}
                    {% set score = scores[characteristic.id] %}
                    {% if score[client_tool.id] is defined %}
                        <tr>
                            <td>
                              {% set responses = score[client_tool.id]['num_responses']|int(0) %}
                              {% set pending_responses = score[client_tool.id]['num_pending_responses'] %}
                              {% if responses %}
                                {% for response in range(responses) %}
                                  <i class="icon-blue icon-circle"></i>
                                {% endfor %}
                              {% endif %}
                              {% for response in range(pending_responses) %}
                                <i class="icon-grey icon-circle"></i>
                              {% endfor %}
                              {% if pending_responses <= 0 %}
                                <i class="icon-blue icon-ok pull-right tooltips" data-placement='top' data-original-title="{{ gettext('You have finished collecting data for this tool') }}"></i>
                              {% elif responses == 0 or pending_responses > responses %}
                                <i class="icon-orange icon-warning-sign pull-right tooltips" data-placement='top' data-original-title="{{gettext('You need to collect more information') }}"></i>
                              {% endif %}
                            </td>
                        </tr>
                    {% endif %}

                  {% endfor %}
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                  </table>
                </td>
                <td class="client-tool-table">
                    <table class="table table-striped">
                        {{ generate_client_rows(scores, client_tools, characteristic.id, score_property='aggregate_score', characteristic_id=characteristic.id) }}
                    <tr>
                        <td class="text-center">{{ total_scores|round_or_none }}</td>
                    </tr>
                    </table>
                </td>
                <td class="text-center relative-score">
                    {% if total_responses == 0 %}
                      -
                    {% else %}
                      {% set class_name = "icon-grey" %}
                      {% if meets_threshold %}
                        {% if score_classification == 'great' %}
                          {% set class_name = "icon-green" %}
                        {% elif score_classification == 'good' %}
                          {% set class_name = "icon-orange" %}
                        {% else %}
                          {% set class_name = "icon-red" %}
                        {% endif %}
                      {% endif %}
                      <i class="big icon-medkit {{ class_name }}"></i>
                      {{ "%s"| format(percentage|int(0)) }}%
                    {% endif %}
                    {% if total_pending_responses <= 0 %}
                      <span class="label label-primary tooltips" data-placement='top' data-original-title="{{gettext('You have finished data collection for this characteristic.') }}"> {{ gettext('Complete') }}</span>
                    {% endif %}
                </td>
              </tr>
            </tbody>
        {% endfor %}
      </table>
      <div class="legend">
        <i class="icon-orange icon-warning-sign"> – You need to collect more information</i>
        <i class="icon-blue icon-ok"> – You have finished collecting data for this tool</i>
      </div>
  </div>
  {% if not loop.last %}
    <div class="page-break"></div>
  {% endif %}
{% endfor %}
{% endblock %}
